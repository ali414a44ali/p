from pyrogram import filters
from pyrogram.types import CallbackQuery, InlineKeyboardButton, InlineKeyboardMarkup, Message
from pyrogram.errors import UsernameInvalid, PeerIdInvalid

from config import BANNED_USERS, OWNER_ID
from VeGa import app
from VeGa.misc import SUDOERS
from VeGa.utils.database import add_sudo, remove_sudo
from VeGa.utils.decorators.language import language
from VeGa.utils.extraction import extract_user

# â”€â”€â”€ Add Sudo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SUDORS = [OWNER_ID]


@app.on_message(filters.command(["Ø§Ø¶Ù Ù…Ø·ÙˆØ±"], "") & filters.private & filters.user(OWNER_ID), group=234455)
@language
async def add_sudo_user(client, message: Message, _):
    try:
        if message.reply_to_message:
            user = message.reply_to_message.from_user
        else:
            ask = await message.reply_text("âŒ¯ï¸™ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ **Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…** Ø£Ùˆ **ÙŠÙˆØ²Ø±Ù†ÙŠÙ…Ù‡**")
            try:
                response = await client.listen(
                    chat_id=message.chat.id,
                    filters=filters.text & filters.private,
                    timeout=30
                )
                user_input = response.text.strip()
            except TimeoutError:
                return await ask.edit_text("âŒ¯ï¸™Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„!")
            finally:
                await ask.delete()

            try:
                user = await client.get_users(user_input)
            except (UsernameInvalid, PeerIdInvalid):
                return await message.reply_text("âŒ¯ï¸™Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø±Ù Ø®Ø§Ø·Ø¦!")

        if user.id in SUDOERS:
            return await message.reply_text(f"âŒ¯ï¸™Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user.mention} Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†!")

        if await add_sudo(user.id):
            SUDOERS.add(user.id)
            await message.reply_text(f"âŒ¯ï¸™ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© {user.mention} Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­ âœ…")
        else:
            await message.reply_text("âŒ¯ï¸™ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…!")

    except Exception as e:
        await message.reply_text(f"âŒ¯ï¸™Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

# â”€â”€â”€ Remove Sudo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@app.on_message(filters.command(["rmsudo"], "") & filters.private & filters.user(OWNER_ID), group=4333)
@language
async def remove_sudo_user(client, message: Message, _):
    try:
        if message.reply_to_message:
            user = message.reply_to_message.from_user
        else:
            ask = await message.reply_text("âŒ¯ï¸™ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ **Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…** Ø£Ùˆ **ÙŠÙˆØ²Ø±Ù†ÙŠÙ…Ù‡**")
            try:
                response = await client.listen(
                    chat_id=message.chat.id,
                    filters=filters.text & filters.private,
                    timeout=30
                )
                user_input = response.text.strip()
            except TimeoutError:
                return await ask.edit_text("âŒ¯ï¸™Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„!")
            finally:
                await ask.delete()

            try:
                user = await client.get_users(user_input)
            except (UsernameInvalid, PeerIdInvalid):
                return await message.reply_text("âŒ¯ï¸™Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø±Ù Ø®Ø§Ø·Ø¦!")

        if user.id not in SUDOERS:
            return await message.reply_text(f"âŒ¯ï¸™Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user.mention} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†!")

        if await remove_sudo(user.id):
            SUDOERS.remove(user.id)
            await message.reply_text(f"âŒ¯ï¸™ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© {user.mention} Ù…Ù† Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­ âœ…")
        else:
            await message.reply_text("âŒ¯ï¸™ÙØ´Ù„ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…!")

    except Exception as e:
        await message.reply_text(f"âŒ¯ï¸™Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

# â”€â”€â”€ Sudo List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@app.on_message(filters.command(["listsudo", "sudoers"], "") & filters.private & ~BANNED_USERS, group=224)
@language
async def sudoers_list(client, message: Message, _):
    if not SUDOERS:
        return await message.reply_text("âŒ¯ï¸™Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø·ÙˆØ±ÙŠÙ† Ù…Ø¶Ø§ÙÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹!")
    
    try:
        owner = await app.get_users(OWNER_ID)
        text = f"**ğ“†° Ù‚Ø§Ø¦Ù…Ø© Ù…Ø·ÙˆØ±ÙŠÙ† Ø§Ù„Ø¨ÙˆØª ğ“†ª**\n\n**ğŸ‘‘ Ø§Ù„Ù…Ø§Ù„Ùƒ:** {owner.mention}\n\n"
        keyboard = []

        count = 1
        for user_id in SUDOERS:
            if user_id == OWNER_ID:
                continue
            try:
                user = await app.get_users(user_id)
                text += f"**ğ“‚… Ø§Ù„Ù…Ø·ÙˆØ± {count}:** {user.mention}\n"
                keyboard.append([InlineKeyboardButton(f"Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø·ÙˆØ± {count}", url=f"tg://user?id={user_id}")])
                count += 1
            except:
                continue

        keyboard.append([InlineKeyboardButton("ğ“‚‘ Ø§ØºÙ„Ø§Ù‚", callback_data="close")])
        await message.reply_text(
            text,
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    except Exception as e:
        await message.reply_text(f"âŒ¯ï¸™Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

# â”€â”€â”€ Delete All Sudo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@app.on_message(filters.command("delallsudo", prefixes=["/", "!", "%", ",", ".", "@", "#"]) & filters.private & filters.user(OWNER_ID))
@language
async def remove_all_sudo_users(client, message: Message, _):
    try:
        if len(SUDOERS) == 0:
            return await message.reply_text("âŒ¯ï¸™Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø·ÙˆØ±ÙŠÙ† Ù„Ø­Ø°ÙÙ‡Ù…!")
        
        count = 0
        for user_id in list(SUDOERS):
            if user_id != OWNER_ID:
                if await remove_sudo(user_id):
                    SUDOERS.remove(user_id)
                    count += 1
        
        await message.reply_text(f"âŒ¯ï¸™ØªÙ… Ø­Ø°Ù {count} Ù…Ø·ÙˆØ±ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­ âœ…")
    
    except Exception as e:
        await message.reply_text(f"âŒ¯ï¸™Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")